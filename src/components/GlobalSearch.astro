---
import { getCollection } from 'astro:content';

const posts = (await getCollection('posts')).filter(p => !p.data.draft);
const writeups = (await getCollection('writeups')).filter(w => !w.data.draft);
const projects = (await getCollection('projects')).filter(p => !p.data.draft);

// Build searchable index
const searchIndex = [
  ...posts.map(post => ({
    type: 'post',
    title: post.data.title,
    description: post.data.description || '',
    tags: post.data.tags || [],
    url: `/blog/${post.slug}/`,
    date: post.data.pubDate
  })),
  ...writeups.map(writeup => ({
    type: 'writeup',
    title: writeup.data.title,
    description: writeup.data.description || '',
    tags: writeup.data.tags || [writeup.data.ctfName] || [],
    url: `/ctf-writeups/${writeup.slug}/`,
    date: writeup.data.pubDate
  })),
  ...projects.map(project => ({
    type: 'project',
    title: project.data.title,
    description: project.data.description || '',
    tags: project.data.skills || [],
    url: project.data.link || '#',
    date: new Date()
  }))
];
---

<div class="mb-8 relative">
  <input
    type="text"
    id="globalSearch"
    placeholder="Search posts, writeups, projects, tags..."
    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600"
  />
  <div id="searchResults" class="mt-2 hidden absolute bg-white border border-gray-300 rounded-lg shadow-lg w-full max-w-2xl z-50 max-h-96 overflow-y-auto"></div>
</div>

<script define:vars={{ searchIndex }}>
  const searchInput = document.getElementById('globalSearch');
  const resultsContainer = document.getElementById('searchResults');

  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();

    if (query.length === 0) {
      resultsContainer.classList.add('hidden');
      return;
    }

    const results = searchIndex.filter(item => {
      const titleMatch = item.title.toLowerCase().includes(query);
      const descriptionMatch = item.description.toLowerCase().includes(query);
      const tagsMatch = item.tags.some(tag => tag.toLowerCase().includes(query));

      return titleMatch || descriptionMatch || tagsMatch;
    });

    if (results.length === 0) {
      resultsContainer.innerHTML = '<div class="p-4 text-gray-500">No results found</div>';
      resultsContainer.classList.remove('hidden');
      return;
    }

    const html = results
      .slice(0, 8)
      .map(item => `
        <a href="${item.url}" class="block p-4 border-b hover:bg-gray-50 transition-colors">
          <div class="flex items-center justify-between">
            <span class="text-xs font-semibold text-blue-600 uppercase">${item.type}</span>
            ${item.date ? `<span class="text-xs text-gray-500">${new Date(item.date).toLocaleDateString()}</span>` : ''}
          </div>
          <h3 class="font-semibold text-gray-900 mt-1">${item.title}</h3>
          ${item.description ? `<p class="text-sm text-gray-600 mt-1">${item.description.substring(0, 100)}...</p>` : ''}
          ${item.tags.length > 0 ? `<div class="flex gap-2 mt-2 flex-wrap">${item.tags.slice(0, 3).map(tag => `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded">${tag}</span>`).join('')}</div>` : ''}
        </a>
      `)
      .join('');

    resultsContainer.innerHTML = html;
    resultsContainer.classList.remove('hidden');
  });

  // Close results when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('#globalSearch') && !e.target.closest('#searchResults')) {
      resultsContainer.classList.add('hidden');
    }
  });
</script>